<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tablet Counter (HSV)</title>

<meta name="theme-color" content="#0f766e">

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f0fdfa;
  color: #042f2e;
  text-align: center;
}
header {
  padding: 20px;
}
button {
  padding: 14px 20px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #0f766e;
  color: white;
}
button.secondary {
  background: #134e4a;
}
.hidden { display: none; }

video, canvas {
  width: 100%;
  max-width: 420px;
  border-radius: 16px;
  margin-top: 10px;
}

#count {
  font-size: 48px;
  font-weight: bold;
  margin: 10px 0;
}
small { color:#555; }
</style>
</head>

<body>

<header id="landing">
  <h2>Tablet Counter</h2>
  <p>HSV Color Detection (Tablet Biru)</p>
  <button onclick="openApp()">Buka Aplikasi</button>
</header>

<header id="app" class="hidden">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" class="hidden"></canvas>

  <div id="count">0</div>

  <button onclick="capture()">Ambil Gambar & Hitung</button>
  <br><br>
  <button class="secondary" onclick="resetApp()">Hitung Ulang</button>

  <br><br>
  <small>Tablet biru, meja terang, tidak bertumpuk</small>
</header>

<script>
const landing = document.getElementById("landing");
const app = document.getElementById("app");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const countEl = document.getElementById("count");

async function openApp() {
  landing.classList.add("hidden");
  app.classList.remove("hidden");

  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "environment",
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  });
  video.srcObject = stream;
}

function capture() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  canvas.classList.remove("hidden");

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const mask = createHSVMask(img);
  const count = countFromMask(mask, canvas.width, canvas.height);

  countEl.textContent = count;
}

/* =========================
   RGB -> HSV
========================= */
function rgbToHsv(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  let max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, v = max;
  let d = max - min;
  s = max === 0 ? 0 : d / max;

  if (max === min) {
    h = 0;
  } else {
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h *= 60;
  }
  return [h, s * 100, v * 100];
}

/* =========================
   HSV MASK (TABLET BIRU)
========================= */
function createHSVMask(img) {
  const d = img.data;
  const w = img.width;
  const h = img.height;
  const mask = new Uint8Array(w * h);

  for (let i = 0, p = 0; i < d.length; i += 4, p++) {
    const [H, S, V] = rgbToHsv(d[i], d[i+1], d[i+2]);

    // RANGE TABLET BIRU
    if (
      H > 190 && H < 240 &&   // Hue biru
      S > 35 &&               // Saturasi
      V > 40                  // Brightness
    ) {
      mask[p] = 1;
    }
  }
  return mask;
}

/* =========================
   COUNT BLOBS
========================= */
function countFromMask(mask, w, h) {
  const visited = new Uint8Array(w * h);
  let count = 0;

  function flood(start) {
    let stack = [start];
    let area = 0;

    while (stack.length) {
      const p = stack.pop();
      if (p < 0 || p >= w * h || visited[p] || !mask[p]) continue;

      visited[p] = 1;
      area++;

      stack.push(p + 1, p - 1, p + w, p - w);
    }
    return area;
  }

  for (let i = 0; i < w * h; i += 4) {
    if (mask[i] && !visited[i]) {
      const area = flood(i);
      if (area > 400 && area < 25000) {
        count++;
      }
    }
  }
  return count;
}

function resetApp() {
  canvas.classList.add("hidden");
  countEl.textContent = "0";
}
</script>

</body>
</html>
